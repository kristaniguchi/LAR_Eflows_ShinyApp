---
title: "LA River"
author: ""
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(ggthemes)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE,comment = NA,message = FALSE)

dat <- read.csv("raw/FlowRanges_Species_RecUses_Allnodes_BU_03172021.csv",
                                       encoding = "UTF-8",stringsAsFactors = FALSE) %>% 
  mutate(Species = factor(Species),
         Species_Label = gsub(" ", "\n",Species_Label),
         Species_Label = factor(Species_Label,levels = c("Willow\nGrowth", "Willow\nAdult", 
                                                         "Typha\nGrowth","Typha\nAdult", 
                                                         "Cladophora\nAdult", "Current\nFlow", 
                                                         "SAS\nGrowth","SAS\nAdult","Steelhead\nMigration\n(Prolonged)",
                                                         "Steelhead\nMigration\n(Burst)","Steelhead\nMigration\n(Smolts)",
                                                         "Rec.\nUse\nKayak","Rec.\nUse\nFishing")),
         Lower_Limit = as.double(Lower_Limit),
         Upper_Limit = as.double(Upper_Limit)) %>% 
  rename(Seasonal_Component= Seasonal.Component)


seasons = dat %>% select(Seasonal_Component) %>% unlist() %>% unique()
names(seasons)=NULL
```

#  {.tabset}

## Optimal Flow Range {.tabset}

```{r}
sidebarPanel(
              radioButtons("location", label = "Select Location:",
                           choices = c("Reporting Reach","Node"),selected="Node"),
              radioButtons("synthesis",label="Species Synthesis:",
                           choices=c("Yes","No"),
              selected="No"))


location_choice <- reactive({
  switch(input$location,
         "Reporting Reach" = dat$Reach,
         "Node"= dat$Node)
  })
```


```{r}
flowLayout(
renderUI({
if(input$location == "Reporting Reach"){
    selectInput("Reach",label = "Select Reach:",
                choices = location_choice() %>% unique)
  }
  else{
    selectInput("Node",label = "Select Node:",
                choices = location_choice() %>% unique)
  }
  
}),
  selectInput("season", label = "Select Season:",
              choices = c("All",seasons),
              selected= c("All",seasons) %>%  .[1]),
  
  selectInput("designations", label = "Benefician Usage:",
              choices = dat$Designation %>% unique %>% .[c(2,3)],
              selected= dat$Designation %>% unique %>% .[2]),
  
  selectInput("probthresh", label = "Probability of Occurrence:",
              choices = dat$Probability_Threshold %>% unique() %>% .[-1],
              selected= dat$Probability_Threshold %>% unique() %>% .[2]),
downloadButton('boxfig', 'Download Boxplot'),
downloadButton('boxdat', 'Download Selected Data')
)
```

```{r}
boxplot_dat <- reactive({
  if(input$season != "All"){
    season = input$season
  }
  else{
    season = seasons
  }
  
  if(input$location == "Node"){
    out <- dat %>% filter(Node == input$Node,
                          Seasonal_Component %in% season,
                          Designation  == input$designations,
                          Probability_Threshold == input$probthresh| is.na(Probability_Threshold))
  }
  if(input$location == "Reporting Reach"){
    out <- dat %>% filter(Reach == input$Reach,
                          Seasonal_Component %in% season,
                          Designation == input$designations,
                          Probability_Threshold == input$probthresh|is.na(Probability_Threshold)) 
  }
  return(out)
})
```



```{r}
box_plot <- reactive({
  
  dat <- boxplot_dat()
  
  if(input$location=="Node"){  
    ggplot(dat,aes(x=Species_Label, ymin = Lower_Limit,
                   lower = Lower_Limit,middle=(Lower_Limit+Upper_Limit)/2,
                   upper = Upper_Limit, ymax = Upper_Limit,
                   fill= Species_Label)) +
      geom_boxplot(stat = "identity",fatten=NULL) +
      facet_wrap(~ Seasonal_Component, scales="free") +
      theme(strip.text = element_text(face="bold", size=12),
            strip.background = element_rect(fill="white", colour="black",size=1)) +
      scale_fill_colorblind()+
      theme(legend.position="bottom",
            panel.grid.minor.y = element_blank()) +
      labs(title="Flow Ranges",x ="", y = "Flow (cfs)",
           fill= "Species - Lifestage")+
  scale_y_log10()
    }
  else{
    ggplot(dat,aes(x=Species_Label, ymin = Lower_Limit,
                   lower = Lower_Limit,middle=(Lower_Limit+Upper_Limit)/2,
                   upper = Upper_Limit, ymax = Upper_Limit,
                   fill= Species_Label)) +
      geom_boxplot(stat = "identity",fatten=NULL) +
      facet_grid(Node~ Seasonal_Component, scales="free") +
      theme(strip.text = element_text(face="bold", size=12),
            strip.background = element_rect(fill="white", colour="black",size=1)) +
      scale_fill_colorblind()+
      theme(legend.position="bottom",
            panel.grid.minor.y = element_blank(),
            ) +
      labs(title="Flow Ranges",x ="", y = "Flow (cfs)",fill="Species - Lifestage")+
  scale_y_log10()
    }
  })


```

```{r}
renderPlot({box_plot()},height=575,width=1000)

output$boxfig <- downloadHandler(
    filename = function() {
      if(input$location=="Node"){
      paste(input$Node, '.png', sep='') 
      }
      else{
      paste(input$Reach, '.png', sep='') 
      }},
    content = function(file) {
        ggsave(file, plot = box_plot(), device = "png",
               width = 30, height = 20, units = "cm")
    }
)

output$boxdat <- downloadHandler(
    filename = function() {
      if(input$location=="Node"){
      paste(input$Node, '.csv', sep='') 
      }
      else{
      paste(input$Reach, '.csv', sep='') 
      }},
    content = function(file) {
      write.csv(boxplot_dat(), file, quote = T, row.names = F)
    }
)

```



## Sensitivity Curves
